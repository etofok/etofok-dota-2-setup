document.addEventListener("DOMContentLoaded",async()=>{const e=document.getElementById("table-of-contents"),t=document.querySelector("main"),n=document.documentElement,o=await fetch("toc.json"),s=await o.json();let i=!1;const a=e=>{const t=parseInt(e.replace("section-",""));if(isNaN(t))return;const o=10+(t-1)/(s.length-1)*90;n.style.setProperty("--progress",`${o}%`)};s.forEach((n,o)=>{e.insertAdjacentHTML("beforeend",`<li><b>${o+1}.</b> <a href="#${n.id}">${n.title}</a></li>`),document.getElementById(n.id)||t.insertAdjacentHTML("beforeend",`<div class="lazy-section" id="${n.id}" data-src="${n.file}"></div>`)});const r=Array.from(document.querySelectorAll(".lazy-section"));async function c(e){if(e&&!e.classList.contains("loaded")&&!e.classList.contains("loading")){e.classList.add("loading");try{const t=await fetch(e.dataset.src).then(e=>e.text());if(e.innerHTML=t,e.classList.add("loaded"),e.style.minHeight="0",e.offsetHeight<window.innerHeight){const t=e.nextElementSibling;t?.classList.contains("lazy-section")&&c(t)}}catch(t){console.error(`Failed to load ${e.id}:`,t)}e.classList.remove("loading")}}const l=new IntersectionObserver(e=>{i||e.forEach(e=>{e.isIntersecting&&(c(e.target),a(e.target.id))})},{root:null,rootMargin:"300px",threshold:0});r.forEach(e=>l.observe(e)),e.addEventListener("click",async e=>{const t=e.target.closest("a");if(!t)return;e.preventDefault(),document.body.classList.add("is-loading"),i=!0;const n=t.getAttribute("href").slice(1),o=document.getElementById(n);if(!o)return;const s=o.previousElementSibling,r=o.nextElementSibling,l=[c(o)];s?.classList.contains("lazy-section")&&l.push(c(s)),r?.classList.contains("lazy-section")&&l.push(c(r)),await Promise.all(l);const d=Array.from(o.querySelectorAll("img"));await Promise.all(d.map(e=>e.complete||!e.src?Promise.resolve():new Promise(t=>{e.onload=e.onerror=t,setTimeout(t,500)}))),requestAnimationFrame(()=>{o.scrollIntoView({block:"start"}),window.location.hash!==`#${n}`&&(window.location.hash=n),a(n),document.body.classList.remove("is-loading"),setTimeout(()=>{i=!1},250)})}),document.querySelector("#logo-navbar")?.addEventListener("click",()=>n.style.setProperty("--progress","0%")),document.querySelector("#button-toc")?.addEventListener("click",()=>n.style.setProperty("--progress","5%"))});
function ensureOverlay(){let e=document.querySelector(".magnify-overlay");if(e)return e;e=document.createElement("div"),e.className="magnify-overlay",e.setAttribute("role","dialog"),e.setAttribute("aria-hidden","true");const t=document.createElement("img");return e.appendChild(t),e.addEventListener("click",()=>{e.classList.remove("active"),e.setAttribute("aria-hidden","true"),setTimeout(()=>{e.querySelector("img").src=""},300)}),document.body.appendChild(e),e}document.addEventListener("click",e=>{const t=e.target.closest(".magnifiable");if(!t)return;const n=ensureOverlay();n.querySelector("img").src=t.src,n.setAttribute("aria-hidden","false"),n.classList.add("active")}),document.addEventListener("keydown",e=>{const t=document.querySelector(".magnify-overlay");"Escape"===e.key&&t?.classList.contains("active")&&(t.classList.remove("active"),t.setAttribute("aria-hidden","true"),setTimeout(()=>{t.querySelector("img").src=""},300))}),document.addEventListener("DOMContentLoaded",()=>{const e=document.querySelectorAll(".lazy-section"),t=document.getElementById("table-of-contents");e.forEach(e=>{const n=e.dataset.section;if(!n)return;if(!/^section-\d/.test(n))return;e.id||(e.id=n);const r=n.replace(/^section-/,""),[i,...c]=r.split("-"),a=c.join(" "),s=a.charAt(0).toUpperCase()+a.slice(1),o=document.createElement("li");o.innerHTML=`<b>${i}.</b> <a href="#${e.id}">${s}</a>`,t.appendChild(o)})});
document.addEventListener("DOMContentLoaded",()=>{const e=document.querySelector(".navbar");function t(){window.scrollY>=0?e.classList.add("scrolled"):e.classList.remove("scrolled")}window.addEventListener("scroll",t),t(),window.addEventListener("popstate",e=>{const t=document.getElementById("donateOverlay");"flex"!==t.style.display||e.state&&e.state.panelOpen||(t.style.display="none")})});
let isFetching=!1;async function ensurePanelLoaded(){const e=document.getElementById("placeholder-panel-donate");if(e&&!isFetching){isFetching=!0;try{const t=await fetch("html/panel-donate.html");if(!t.ok)throw new Error(t.status);const n=await t.text(),o=document.createElement("div");o.innerHTML=n,e.replaceWith(...o.childNodes)}catch(e){console.error("Drop failed:",e)}finally{isFetching=!1}}}async function toggleDonatePanel(e){e?.preventDefault(),await ensurePanelLoaded();const t=document.getElementById("donateOverlay");if(!t)return;const n="flex"===t.style.display;t.style.display=n?"none":"flex",n?history.state?.panelOpen&&history.replaceState({},"",window.location.pathname):history.pushState({panelOpen:!0},"","#donate-panel-open")}document.addEventListener("keydown",e=>{"Escape"===e.key&&"flex"===document.getElementById("donateOverlay")?.style.display&&toggleDonatePanel(e)}),window.addEventListener("popstate",()=>{const e=document.getElementById("donateOverlay");e&&(e.style.display="none")});let soundCoins=null;document.addEventListener("mouseover",e=>{e.target.closest(".button-donate")&&(ensurePanelLoaded(),soundCoins||(soundCoins=new Audio("assets/sfx/coins.wav"),soundCoins.preload="auto"),soundCoins.currentTime=0,soundCoins.play().catch(()=>{}))},{passive:!0}),document.addEventListener("click",e=>{const t=e.target.closest(".button-donate"),n="donateOverlay"===e.target.id;(t||n)&&toggleDonatePanel(e)});